\documentclass[border=10pt]{standalone}
\input{config}

\begin{document}
\begin{tikzpicture}

    %%% hashtable
    \begin{struct}[Boot Class Hash Table]{hashtable}{4.5cm}{2em}
        \record{HashEntry *hash_table;}
        \record{int hash_size;}
        \record{int hash_count;}
        \record{VMLock lock;}
    \end{struct}


    %%% hash data
    \begin{struct}[][right=3cm of hashtable-0]{hashdata1}{4cm}{2em}
        \record{...}
        \record{hash(classname)}
        \record{...}
    \end{struct}
    \begin{struct}[][right=0cm of hashdata1-0]{hashdata2}{4cm}{2em}
        \record{...}
        \record{void *data;}
        \record{...}
    \end{struct}


    %%% Class
    \begin{struct}[Class][right=3cm of hashdata2-0]{class}{9cm}{2em}
        \record[fill=blue!30]{uintptr_t lock;}
        \record[fill=blue!30]{Class *class;}
        \record{u1 state;}
        \record{u2 access_flags;}
        \record{u2 declaring_class;}
        \record{u2 enclosing_class;}
        \record{u2 enclosing_method;}
        \record{u2 inner_access_flags;}
        \record{u2 fields_count;}
        \record{u2 methods_count;}
        \record{u2 interfaces_count;}
        \record{u2 inner_class_count;}
        \record{u2 constant_pool_count;}
        \record{int object_size;}
        \record{int method_table_size;}
        \record{int imethod_table_size;}
        \record{int initing_tid;}
        \record{char *name;}
        \record{char *signature;}
        \record{char *source_file_name;}
        \record{Class *super;}
        \record{Class **interfaces;}
        \record{MethodBlock **method_table;}
        \record{ITableEntry *imethod_table;}
        \record{char *bootstrap_methods;}
        \record{ExtraAttributes *extra_attributes;}
        \record{ConstantPool constant_pool;}
    \end{struct}
    \begin{struct}[][below=of class.south west,anchor=north west]{class-union-left}{4.5cm}{7.5em}
        \record{int dimension;}
        \record{Class *element_class;}
    \end{struct}
    \begin{struct}[][below=of class,right=of class-union-left-0]{class-union-left}{4.5cm}{3em}
        \record{u2 *inner_classes;}
        \record{FieldBlock *fields;}
        \record{MethodBlock *methods;}
        \record{int refs_offsets_size;}
        \record{RefsOffsetsEntry *\\refs_offsets_table;}
    \end{struct}


    %%% FieldBlock
    \begin{struct}[FieldBlock][below=3cm of hashtable]{field}{5cm}{2em}
        \record{Class *class;}
        \record{char *name;}
        \record{char *type;}
        \record{char *signature;}
        \record{u2 access_flags;}
        \record{u2 constant;}
        \record{char data[8]; or offset}
    \end{struct}


    %%% MethodBlock
    \begin{struct}[MethodBlock][below=3cm of field]{method}{10.5cm}{2em}
        \record{Class *clas;}
        \record{char *name;}
        \record{char *type;}
        \record{char *signature;}
        \record{u1 state;}
        \record{u1 flags;}
        \record{u2 access_flags;}
        \record{u2 max_stack;}
        \record{u2 max_locals;}
        \record{u2 args_count;}
        \record{u2 throw_table_size;}
        \record{u2 *throw_table;}
        \record{void *code;}
        \record{int code_size;}
        \record{int method_table_index;}
    \end{struct}
    \begin{struct}[][below=of method.south west,anchor=north west]{method-union-left}{5cm}{3em}
        \record{u2 exception_table_size;}
        \record{u2 line_no_table_size;}
        \record{ExceptionTableEntry *\\exception_table;}
        \record{LineNoTableEntry *\\line_no_table;}
    \end{struct}
    \begin{struct}[][right=of method-union-left.north east,anchor=north west]{method-union-right}{5.5cm}{4em}
        \record{char *simple_sig;}
        \record{int native_extra_arg;}
        \record{NativeMethod native_invoker;}
    \end{struct}


    %%% lines
    \draw[arrow] (hashtable-1.east) to[out=0,in=180] (hashdata1-2.west);
    \draw[arrow] (hashdata2-2.east) to[out=0,in=180] (class-1.west);
    \draw[right brace] (class-1.north east) -- node[right note]{class header} (class-2.south east);
\end{tikzpicture}
\end{document}


